name: Deploy Backend to Cafe24

on:
  push:
    branches: [ main ]
    paths: ['be/**']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Build
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create application-prod.yml with secrets
        run: echo "${{ secrets.APPLICATION_PROD_YML }}" > be/src/main/resources/application-prod.yml

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./be
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/football-club-backend:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/football-club-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CAFE24_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
          ssh-keyscan -H ${{ secrets.CAFE24_HOST }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose.yml to server
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.yml root@${{ secrets.CAFE24_HOST }}:/opt/football-club/

      - name: Setup environment variables
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            cd /opt/football-club &&
            echo 'MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}' > .env &&
            echo 'MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}' >> .env &&
            echo 'MYSQL_USER=${{ secrets.MYSQL_USER }}' >> .env &&
            echo 'MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}' >> .env
          "

      - name: Pull and tag Docker image
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            docker pull ${{ secrets.DOCKER_USERNAME }}/football-club-backend:${{ github.sha }} &&
            docker tag ${{ secrets.DOCKER_USERNAME }}/football-club-backend:${{ github.sha }} football-club-backend:latest
          "

      - name: Determine Blue-Green deployment ports
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            # Check which containers are running
            BLUE_RUNNING=\$(docker ps --filter \"name=backend-blue\" -q | wc -l)
            GREEN_RUNNING=\$(docker ps --filter \"name=backend-green\" -q | wc -l)
            
            if [ \$BLUE_RUNNING -gt 0 ] && [ \$GREEN_RUNNING -eq 0 ]; then
              # Blue is running, deploy green
              echo \"NEW_COLOR=green\" >> /tmp/deploy_vars
              echo \"NEW_PORT=8083\" >> /tmp/deploy_vars
              echo \"OLD_COLOR=blue\" >> /tmp/deploy_vars
              echo \"OLD_PORT=8082\" >> /tmp/deploy_vars
            elif [ \$GREEN_RUNNING -gt 0 ] && [ \$BLUE_RUNNING -eq 0 ]; then
              # Green is running, deploy blue
              echo \"NEW_COLOR=blue\" >> /tmp/deploy_vars
              echo \"NEW_PORT=8082\" >> /tmp/deploy_vars
              echo \"OLD_COLOR=green\" >> /tmp/deploy_vars
              echo \"OLD_PORT=8083\" >> /tmp/deploy_vars
            else
              # Neither or both running, default to blue
              echo \"NEW_COLOR=blue\" >> /tmp/deploy_vars
              echo \"NEW_PORT=8082\" >> /tmp/deploy_vars
              echo \"OLD_COLOR=green\" >> /tmp/deploy_vars
              echo \"OLD_PORT=8083\" >> /tmp/deploy_vars
            fi
            
            source /tmp/deploy_vars
            echo \"Deploying: backend-\$NEW_COLOR on port \$NEW_PORT (stopping \$OLD_COLOR on \$OLD_PORT)\"
          "

      - name: Clean up target container only
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            source /tmp/deploy_vars
            
            # Only clean up the target container (NEW_COLOR) - keep OLD_COLOR running
            echo \"Cleaning up target container: backend-\$NEW_COLOR\"
            docker stop backend-\$NEW_COLOR 2>/dev/null || true
            docker rm backend-\$NEW_COLOR 2>/dev/null || true
            
            # Clean up legacy 'backend' container if exists
            docker stop backend 2>/dev/null || true
            docker rm backend 2>/dev/null || true
            
            # Kill processes on target port only
            echo \"Freeing up target port \$NEW_PORT\"
            lsof -ti:\$NEW_PORT 2>/dev/null | xargs -r kill -9 2>/dev/null || true
            
            sleep 2
            
            echo \"Current running containers:\"
            docker ps --filter \"name=backend\"
          "

      - name: Setup Redis container
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            docker run -d --name redis-container -p 6379:6379 redis:7-alpine 2>/dev/null || echo \"Redis already running\"
          "

      - name: Start new backend container
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            cd /opt/football-club &&
            source /tmp/deploy_vars
            echo \"Starting backend-\$NEW_COLOR on port \$NEW_PORT\"
            docker run -d --name backend-\$NEW_COLOR -p \$NEW_PORT:8082 --env-file .env -e SPRING_PROFILES_ACTIVE=prod -e REDIS_HOST=localhost football-club-backend:latest
            sleep 5
            echo \"Container status:\"
            docker ps | grep backend-\$NEW_COLOR || echo \"Container not running\"
            echo \"Container logs:\"
            docker logs backend-\$NEW_COLOR | tail -20
          "

      - name: Health check
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            source /tmp/deploy_vars
            echo \"Starting health check for backend-\$NEW_COLOR on port \$NEW_PORT\"
            for i in {1..30}; do
              echo \"Health check attempt \$i/30\"
              if curl -f http://localhost:\$NEW_PORT/api/test/health 2>/dev/null; then
                echo \"✅ Health check passed\"
                break
              fi
              if [ \$i -eq 30 ]; then
                echo \"❌ Deploy failed - health check timeout\"
                echo \"Container logs:\"
                docker logs backend-\$NEW_COLOR | tail -20
                echo \"Container status:\"
                docker ps -a | grep backend-\$NEW_COLOR
                docker rm -f backend-\$NEW_COLOR
                exit 1
              fi
              sleep 10
            done
          "

      - name: Update Nginx configuration and switch traffic
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            source /tmp/deploy_vars
            echo \"Switching traffic from port \$OLD_PORT to \$NEW_PORT\"
            
            # Backup current nginx config
            sudo cp /etc/nginx/sites-enabled/nginx.conf /etc/nginx/sites-enabled/nginx.conf.backup
            
            # Update nginx configuration to point to new container
            sudo sed -i \"s/proxy_pass http:\/\/localhost:[0-9]*\/api\//proxy_pass http:\/\/localhost:\$NEW_PORT\/api\//g\" /etc/nginx/sites-enabled/nginx.conf
            
            # Test and reload nginx
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo \"✅ Traffic switched to backend-\$NEW_COLOR on port \$NEW_PORT\"
            else
              echo \"❌ Nginx config test failed, reverting\"
              sudo mv /etc/nginx/sites-enabled/nginx.conf.backup /etc/nginx/sites-enabled/nginx.conf
              exit 1
            fi
          "

      - name: Clean up old containers and finalize
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
            source /tmp/deploy_vars
            
            echo \"Waiting 30 seconds to ensure traffic switch is stable...\"
            sleep 30
            
            # Now safe to remove old container since traffic is switched
            echo \"Removing old container: backend-\$OLD_COLOR\"
            docker stop backend-\$OLD_COLOR 2>/dev/null || true
            docker rm backend-\$OLD_COLOR 2>/dev/null || true
            
            # Clean up legacy container
            docker stop backend 2>/dev/null && docker rm backend 2>/dev/null || true
            
            # Clean up unused images
            docker image prune -f
            
            echo \"✅ Blue-Green deployment completed successfully!\"
            echo \"Active container: backend-\$NEW_COLOR on port \$NEW_PORT\"
            docker ps --filter \"name=backend\"
            
            rm -f /tmp/deploy_vars
          "

      - name: Deployment notification
        run: echo "✅ Backend deployment completed successfully!"
