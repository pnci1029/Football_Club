name: Deploy Backend to Cafe24

on:
  push:
    branches: [ main ]
    paths: ['be/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create application-prod.yml with secrets
      run: echo "${{ secrets.APPLICATION_PROD_YML }}" > be/src/main/resources/application-prod.yml

    - name: Create project archive
      run: |
        tar -czf football-club.tar.gz --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='.gradle' --exclude='.idea' --exclude='*.iml' --exclude='.gitignore' . || true
        ls -la football-club.tar.gz

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.CAFE24_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
        ssh-keyscan -H ${{ secrets.CAFE24_HOST }} >> ~/.ssh/known_hosts

    - name: Copy archive to server
      run: |
        scp -i ~/.ssh/id_rsa football-club.tar.gz root@${{ secrets.CAFE24_HOST }}:/opt/football-club/

    - name: Deploy backend on server
      run: |
        ssh -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
          cd /opt/football-club &&
          echo 'MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}' > .env &&
          echo 'MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}' >> .env &&
          echo 'MYSQL_USER=${{ secrets.MYSQL_USER }}' >> .env &&
          echo 'MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}' >> .env &&
          echo 'MYSQL_HOST=db' >> .env &&
          rm -rf app || true &&
          mkdir -p app &&
          tar -xzf football-club.tar.gz -C app &&
          cp -r app/scripts . &&
          chmod +x scripts/*.sh &&
          cp app/docker-compose.yml . &&
          export APPLICATION_PROD_YML='${{ secrets.APPLICATION_PROD_YML }}' &&
          ./scripts/cafe24-deploy.sh backend
        "

    - name: Deployment notification
      run: echo "âœ… Backend deployment completed successfully!"
