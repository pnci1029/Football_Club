name: Deploy Frontend to Cafe24

on:
  push:
    branches: [ main ]
    paths: ['fe/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create project archive
      run: |
        tar -czf football-club.tar.gz --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='.gradle' --exclude='.idea' --exclude='*.iml' --exclude='.gitignore' . || true
        ls -la football-club.tar.gz

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.CAFE24_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
        ssh-keyscan -H ${{ secrets.CAFE24_HOST }} >> ~/.ssh/known_hosts

    - name: Copy archive to server
      run: |
        scp -i ~/.ssh/id_rsa football-club.tar.gz root@${{ secrets.CAFE24_HOST }}:/opt/football-club/

    - name: Deploy frontend on server
      run: |
        ssh -i ~/.ssh/id_rsa root@${{ secrets.CAFE24_HOST }} "
          cd /opt/football-club &&
          rm -rf app || true &&
          mkdir -p app &&
          tar -xzf football-club.tar.gz -C app &&
          cp -r app/scripts . &&
          chmod +x scripts/*.sh &&
          cp app/docker-compose.yml . &&
          ./scripts/cafe24-deploy.sh frontend
        "

    - name: Deployment notification
      run: echo "âœ… Frontend deployment completed successfully!"